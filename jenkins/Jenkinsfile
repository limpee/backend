pipeline {

    agent any

    stages {

        stage('Checkout') {

            steps {

                echo "Teste de Hello Wordl!"

            }

        }

        stage('Grant key permission') {

            steps {

                sh "chmod 400 /home/ec2-user/keys/backend-key.pem"

            }

        }

        stage('Access backend EC2') {

            steps {

                script {
                    def remoteHost = 'ec2-3-214-52-91.compute-1.amazonaws.com'
                    // def remoteUser = 'ec2-user'
                    def remoteUser = 'ec2-user'
                    //def keyPath = '/path/to/private/key.pem'
                    def keyPath =  '/home/ec2-user/keys/backend-key.pem'
                    //def remoteDir = '~/apl-back-zup'
                    def remoteDir = '~/repo/backend'

                    // Altera as permiss√µes da chave
                   // sh "chmod 600 ${keyPath}"

                   sh """
                   ssh -o StrictHostKeyChecking=no -i /home/ec2-user/keys/backend-key.pem ec2-user@ec2-3-214-52-91.compute-1.amazonaws.com "cd ~/repo/backend && sudo git fetch && sudo git pull"
                   """
                }

            }

        }
    }
}